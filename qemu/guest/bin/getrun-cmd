#!/bin/bash
usage() {
    echo "usage: $0 [ OPTIONS ] EXECUTABLE_NAME [ ARGS... ]"
    echo "OPTIONS:"
    echo "  -h,--help           Show this help message"
    echo "  --stdin DATA        Pass DATA on stdin"
    echo "  --sym-stdin NBYTES  Pass NBYTES symbolic bytes on stdin"
}

check() {
    "$@"
    if [ $? -ne 0 ]; then exit 1; fi
}

check s2eget cmd-config

bin=`head -n1 cmd-config`
args="`tail -n+2 cmd-config | head -n1`"
stdin="`tail -n+3 cmd-config | head -n1`"
sym_stdin="`tail -n1 cmd-config`"
cmd="LD_PRELOAD=$HOME/lib/init_env.so ./$bin $args"

check s2eget $bin
check chmod +x $bin
if [ "$stdin" != "" ]; then
    echo $stdin | (eval $cmd)
else
    if [ $sym_stdin -ne 0 ]; then
        s2ecmd symbwrite $sym_stdin | (eval $cmd)
    else
        eval $cmd
    fi
fi
s2ecmd kill 0 "$bin finished"
